load(
    "//tfdml:tfdml.bzl",
    "if_not_windows",
    "if_windows",
)

# Target comprising source that (mostly) originates from the core TF runtime and is needed
# to implement the core TFDML plugin and its kernels. There is no clear interface between
# the TF runtime and device backend/kernels in TF1.15, and many of the TFDML classes/kernels
# are ported from TF1.15 fork.
#
# WARNING: Some of the files in this library are under Apache license and largely unmodified
# from their original form. Other files simply retain the original struct/class names but are
# total rewrites. Pay careful attention to license banners when modifying code in this
# target. We may choose to further refactor these files over time to simplify layering.
cc_library(
    name = "runtime_adapter",
    srcs = [
        "runtime_adapter/allocator.cc",
        "runtime_adapter/allocator_retry.cc",
        "runtime_adapter/bcast.cc",
        "runtime_adapter/bfc_allocator.cc",
        "runtime_adapter/device.cc",
        "runtime_adapter/env.cc",
        "runtime_adapter/env_var.cc",
        "runtime_adapter/fused_eigen_output_kernels.cc",
        "runtime_adapter/kernel_shape_util.cc",
        "runtime_adapter/numbers.cc",
        "runtime_adapter/op_kernel_construction.cc",
        "runtime_adapter/op_kernel_context.cc",
        "runtime_adapter/padding.cc",
        "runtime_adapter/resource_mgr.cc",
        "runtime_adapter/status.cc",
        "runtime_adapter/tensor.cc",
        "runtime_adapter/tensor_format.cc",
        "runtime_adapter/tensor_shape.cc",
        "runtime_adapter/tensor_shape_utils.cc",
        "runtime_adapter/types.cc",
        "runtime_adapter/xplane_builder.cc",
    ],
    hdrs = [
        "runtime_adapter/allocator.h",
        "runtime_adapter/allocator_retry.h",
        "runtime_adapter/attribute.h",
        "runtime_adapter/bcast.h",
        "runtime_adapter/bfc_allocator.h",
        "runtime_adapter/device.h",
        "runtime_adapter/env.h",
        "runtime_adapter/env_var.h",
        "runtime_adapter/fused_eigen_output_kernels.h",
        "runtime_adapter/kernel_shape_util.h",
        "runtime_adapter/macros.h",
        "runtime_adapter/matmul_bcast.h",
        "runtime_adapter/node_def.h",
        "runtime_adapter/numbers.h",
        "runtime_adapter/op_defs.h",
        "runtime_adapter/op_defs_core.h",
        "runtime_adapter/op_defs_dml.h",
        "runtime_adapter/op_kernel.h",
        "runtime_adapter/op_kernel_construction.h",
        "runtime_adapter/op_kernel_context.h",
        "runtime_adapter/padding.h",
        "runtime_adapter/refcount.h",
        "runtime_adapter/resource_mgr.h",
        "runtime_adapter/resource_var.h",
        "runtime_adapter/status.h",
        "runtime_adapter/statusor.h",
        "runtime_adapter/stream.h",
        "runtime_adapter/tensor.h",
        "runtime_adapter/tensor_format.h",
        "runtime_adapter/tensor_shape.h",
        "runtime_adapter/tensor_shape_utils.h",
        "runtime_adapter/types.h",
        "runtime_adapter/wide_char.h",
        "runtime_adapter/xplane_builder.h",
    ],
    copts = if_windows([
        "-DDML_BUILD_WINDOWS",
        "-D_WIN32_WINNT=_WIN32_WINNT_WIN10",
    ]),
    linkopts = if_windows([
        "pathcch.lib",
        "advapi32.lib",
    ]) + if_not_windows([
        "-Wl,-rpath,$$ORIGIN/directml",
    ]),
    linkstatic = 1,
    visibility = ["//visibility:public"],
    deps = [
        "@dml_redist//:headers",
        "@directml//:directmlx",
        "@directx_headers//:directx_headers",
        "@directx_headers//:directx_guids",
        "@directx_headers//:directx_winadapter",
        "@com_google_absl//absl/base",
        "@com_google_absl//absl/base:config",
        "@com_google_absl//absl/base:core_headers",
        "@com_google_absl//absl/container:flat_hash_map",
        "@com_google_absl//absl/container:flat_hash_set",
        "@com_google_absl//absl/container:hash_function_defaults",
        "@com_google_absl//absl/container:inlined_vector",
        "@com_google_absl//absl/container:raw_hash_map",
        "@com_google_absl//absl/container:raw_hash_set",
        "@com_google_absl//absl/strings",
        "@com_google_absl//absl/strings:str_format",
        "@com_google_absl//absl/synchronization",
        "@com_google_absl//absl/time",
        "@com_google_absl//absl/types:optional",
        "@com_google_absl//absl/types:span",
        "@com_google_absl//absl/types:variant",
        "@tensorflow//:headers",
        "@tensorflow//:lib",
        "@tensorflow//:resource_handle_cc_proto",
    ] + if_windows(["@pix//:headers"]),
    alwayslink = 1,
)

# Target comprising core TFDML runtime_adapter code.
cc_library(
    name = "core",
    srcs = [
        "core/dml_adapter.cc",
        "core/dml_adapter_impl.cc",
        "core/dml_bfc_allocator.cc",
        "core/dml_buffer.cc",
        "core/dml_buffer_region.cc",
        "core/dml_command_list.cc",
        "core/dml_command_queue.cc",
        "core/dml_descriptor_bfc_allocator.cc",
        "core/dml_descriptor_heap_allocator.cc",
        "core/dml_descriptor_pool.cc",
        "core/dml_device.cc",
        "core/dml_device_cache.cc",
        "core/dml_device_context.cc",
        "core/dml_device_state.cc",
        "core/dml_dso_loader.cc",
        "core/dml_error_handling.cc",
        "core/dml_event_queue.cc",
        "core/dml_execution_context.cc",
        "core/dml_guids.cc",
        "core/dml_heap_allocator.cc",
        "core/dml_kernel_context.cc",
        "core/dml_kernel_key.cc",
        "core/dml_kernel_manager.cc",
        "core/dml_kernel_wrapper.cc",
        "core/dml_operator_helper.cc",
        "core/dml_ops_common.cc",
        "core/dml_pooled_heap.cc",
        "core/dml_readback_heap.cc",
        "core/dml_tensor_desc.cc",
        "core/dml_tracing.cc",
        "core/dml_upload_heap.cc",
        "core/dml_util.cc",
    ],
    hdrs = [
        "core/dml_adapter.h",
        "core/dml_adapter_heuristics.h",
        "core/dml_adapter_impl.h",
        "core/dml_bfc_allocator.h",
        "core/dml_buffer.h",
        "core/dml_buffer_region.h",
        "core/dml_command_allocator_ring.h",
        "core/dml_command_list.h",
        "core/dml_command_queue.h",
        "core/dml_common.h",
        "core/dml_descriptor_bfc_allocator.h",
        "core/dml_descriptor_heap_allocator.h",
        "core/dml_descriptor_pool.h",
        "core/dml_device.h",
        "core/dml_device_cache.h",
        "core/dml_device_context.h",
        "core/dml_device_state.h",
        "core/dml_dso_loader.h",
        "core/dml_error_handling.h",
        "core/dml_event_queue.h",
        "core/dml_execution_context.h",
        "core/dml_gpu_event.h",
        "core/dml_guids.h",
        "core/dml_heap_allocator.h",
        "core/dml_kernel_context.h",
        "core/dml_kernel_definition.h",
        "core/dml_kernel_key.h",
        "core/dml_kernel_manager.h",
        "core/dml_kernel_wrapper.h",
        "core/dml_operator_helper.h",
        "core/dml_ops_common.h",
        "core/dml_pooled_heap.h",
        "core/dml_readback_heap.h",
        "core/dml_tensor_desc.h",
        "core/dml_tracing.h",
        "core/dml_upload_heap.h",
        "core/dml_util.h",
    ],
    copts = if_windows([
        "-DDML_BUILD_WINDOWS",
        "-D_WIN32_WINNT=_WIN32_WINNT_WIN10",
    ]),
    linkopts = if_windows([
        "pathcch.lib",
        "advapi32.lib",
    ]) + if_not_windows([
        "-Wl,-rpath,$$ORIGIN/directml",
    ]),
    linkstatic = 1,
    visibility = ["//visibility:public"],
    deps = [
        "//tfdml:runtime_adapter",
        "@dml_redist//:headers",
        "@directml//:directmlx",
        "@directx_headers//:directx_headers",
        "@directx_headers//:directx_guids",
        "@directx_headers//:directx_winadapter",
        "@com_google_absl//absl/base",
        "@com_google_absl//absl/base:config",
        "@com_google_absl//absl/base:core_headers",
        "@com_google_absl//absl/container:flat_hash_map",
        "@com_google_absl//absl/container:flat_hash_set",
        "@com_google_absl//absl/container:hash_function_defaults",
        "@com_google_absl//absl/container:inlined_vector",
        "@com_google_absl//absl/container:raw_hash_map",
        "@com_google_absl//absl/container:raw_hash_set",
        "@com_google_absl//absl/strings",
        "@com_google_absl//absl/strings:str_format",
        "@com_google_absl//absl/synchronization",
        "@com_google_absl//absl/time",
        "@com_google_absl//absl/types:optional",
        "@com_google_absl//absl/types:span",
        "@com_google_absl//absl/types:variant",
        "@tensorflow//:headers",
        "@tensorflow//:lib",
        "@tensorflow//:resource_handle_cc_proto",
        "@tensorflow//:xplane_cc_proto",
    ] + if_windows(["@pix//:headers"]),
    alwayslink = 1,
)

# Target comprising all TFDML kernel implementations.
cc_library(
    name = "kernels",
    srcs = [
        "kernels/dml_addn_op.cc",
        "kernels/dml_assign_variable_op.cc",
        "kernels/dml_concat_op.cc",
        "kernels/dml_conv_ops.cc",
        "kernels/dml_gather_nd_op.cc",
        "kernels/dml_gather_op.cc",
        "kernels/dml_matmul_op.cc",
        "kernels/dml_strided_slice_op.cc",
    ],
    hdrs = [
        "kernels/pch.h",
    ],
    linkstatic = 1,
    visibility = ["//visibility:public"],
    deps = [
        "//tfdml:core",
        "@com_google_absl//absl/cleanup",
    ],
    alwayslink = True,
)

# Target to build the TF plugin module.
cc_binary(
    name = "tfdml_plugin",
    srcs = [
        "plugin/plugin_device.cc",
        "plugin/plugin_kernel.cc",
        "plugin/plugin_profiler.cc",
    ],
    features = ["windows_export_all_symbols"],
    linkshared = True,
    visibility = ["//visibility:public"],
    deps = [
        "//tfdml:core",
        "//tfdml:kernels",
        "@directml//:directmlx",
        "@directx_headers",
        "@directx_headers//:directx_guids",
        "@directx_headers//:directx_winadapter",
        "@dml_redist//:headers",
        "@tensorflow//:headers",
    ],
)

config_setting(
    name = "linux_x86_64",
    values = {"cpu": "k8"},
    visibility = ["//visibility:public"],
)
